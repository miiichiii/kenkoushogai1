<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>第3回確認テスト（健康障害１）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
      line-height:1.6;color:#333;
      background:linear-gradient(135deg,#a8edea,#fed6e3);
      background-size:cover;background-repeat:no-repeat;background-attachment:fixed;
      padding:20px;margin:0;
    }
    .container{max-width:800px;margin:0 auto;}
    h1,h2{font-family:'Noto Sans JP',sans-serif;font-weight:700;text-align:center;}
    .quiz-container,.result-card{
      background-color:rgba(255,255,255,0.2);
      backdrop-filter:blur(10px);
      border-radius:16px;padding:20px;margin-bottom:20px;
      border:1px solid rgba(255,255,255,0.3);
      box-shadow:0 8px 24px rgba(0,0,0,0.2);
    }
    #progress-container{width:100%;background-color:rgba(255,255,255,0.3);border-radius:10px;margin-bottom:5px;padding:4px;}
    #progress-bar{height:12px;width:0%;background:linear-gradient(135deg,#007aff,#5ac8fa);border-radius:6px;transition:width .4s ease-in-out;}
    #progress-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:0 5px;font-weight:bold;font-size:.9em;color:#1d1d1f;}
    .question{font-size:1.3em;margin-bottom:20px;color:#1d1d1f;}
    .options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;}
    .option{
      background-color:rgba(255,255,255,.7);border:none;border-radius:16px;padding:15px;
      font-size:1em;cursor:pointer;position:relative;overflow:hidden;text-align:center;
      transition:background .3s ease,transform .3s ease,box-shadow .3s ease;
      box-shadow:0 4px 8px rgba(0,0,0,.1);
    }
    .option:hover{background-color:#fff;box-shadow:0 8px 16px rgba(0,0,0,.2);transform:translateY(-2px);}
    .option.selected{color:#fff;}
    .option.disabled{pointer-events:none;}
    .option.correct{background:linear-gradient(135deg,#34c759,#a8e6cf);color:#fff;}
    .option.incorrect{background:linear-gradient(135deg,#ff3b30,#ff9a8b);color:#fff;}
    .explanation{
      margin-top:20px;font-size:1em;color:#333;background-color:rgba(255,255,255,.8);
      border-left:5px solid;border-radius:12px;padding:15px;
      box-shadow:0 4px 8px rgba(0,0,0,.1);display:none;opacity:0;transition:opacity .5s ease;
    }
    .explanation-header{display:flex;align-items:center;margin-bottom:10px;font-weight:bold;}
    .explanation-icon{font-size:1.5em;margin-right:10px;}
    .nav-button{
      background:linear-gradient(135deg,#007aff,#5ac8fa);color:#fff;border:none;border-radius:12px;
      padding:12px 24px;font-size:1em;cursor:pointer;width:100%;margin-top:20px;
      transition:background .3s ease,transform .2s ease,box-shadow .3s ease,opacity .3s ease;
      box-shadow:0 4px 8px rgba(0,0,0,.1);
    }
    .nav-button:hover{background:linear-gradient(135deg,#005bb5,#4aa0d3);box-shadow:0 8px 16px rgba(0,0,0,.2);}
    .nav-button:disabled{background:linear-gradient(135deg,#c7c7cc,#d1d1d6);opacity:.6;cursor:not-allowed;box-shadow:none;transform:none;}
    .nav-button:active{transform:scale(.98);}
    .result-card h3{font-size:1.2em;margin-bottom:10px;}
    .result-status{font-weight:bold;margin-bottom:10px;}
    .correct{color:#34c759;}
    .incorrect{color:#ff3b30;}
    #incorrect-summary{background-color:rgba(255,235,238,.8);border:1px solid #ff3b30;border-radius:12px;padding:15px;margin-bottom:20px;}
    #incorrect-summary h3{margin-top:0;}
    #incorrect-summary a{display:inline-block;margin:5px;padding:5px 10px;background-color:#ff3b30;color:#fff;text-decoration:none;border-radius:8px;transition:background-color .3s;}
    #incorrect-summary a:hover{background-color:#c50000;}
    #attendance-link{background-color:#34c759;color:#fff;padding:15px;border-radius:12px;margin-top:20px;text-align:center;display:none;}
    #attendance-link a{color:#fff;text-decoration:none;font-weight:bold;}

    /* ---- 成績カード ---- */
    #summary-card{background:rgba(255,255,255,.3);border:1px solid rgba(255,255,255,.4);padding:25px;}
    .summary-grid{display:flex;align-items:center;justify-content:center;gap:30px;flex-wrap:wrap;}
    .score-display{display:grid;place-items:center;}
    @property --p{syntax:'<number>';inherits:true;initial-value:0;}
    .score-circle{
      --p:20;--b:20px;--c:#34c759;--w:180px;
      width:var(--w);aspect-ratio:1;position:relative;display:inline-grid;margin:5px;
      place-content:center;font-size:2.5em;font-weight:bold;animation:progress-load 1s .5s both;
    }
    .score-circle:before,.score-circle:after{content:"";position:absolute;border-radius:50%;}
    .score-circle:before{
      inset:0;
      background:
        radial-gradient(farthest-side,var(--c) 98%,#0000) top/var(--b) var(--b) no-repeat,
        conic-gradient(var(--c) calc(var(--p)*1%),#0000 0);
      -webkit-mask:radial-gradient(farthest-side,#0000 calc(99% - var(--b)),#000 calc(100% - var(--b)));
              mask:radial-gradient(farthest-side,#0000 calc(99% - var(--b)),#000 calc(100% - var(--b)));
    }
    .score-circle:after{inset:calc(50% - var(--b)/2);background:var(--c);transform:rotate(calc(var(--p)*3.6deg)) translateY(calc(50% - var(--w)/2));}
    @keyframes progress-load{from{--p:0;}}
    .score-percentage small{font-size:.5em;color:#555;}
    .stats-details{display:flex;flex-direction:column;gap:15px;}
    .stat-item{display:flex;align-items:center;background-color:rgba(255,255,255,.5);border-radius:12px;padding:10px 15px;}
    .stat-icon{font-size:1.5em;margin-right:12px;}
    .stat-label{font-size:.9em;color:#333;margin-right:auto;}
    .stat-value{font-size:1.2em;font-weight:bold;color:#000;}
    .feedback-message{text-align:center;margin-top:20px;font-size:1.1em;font-weight:500;padding:10px;border-radius:10px;background-color:rgba(255,255,255,.3);}
  </style>
</head>
<body>
  <div class="container">
    <h1>第3回確認テスト（健康障害１）</h1>

    <div id="quiz-container" class="quiz-container">
      <div id="progress-container"><div id="progress-bar"></div></div>
      <div id="progress-info">
        <div id="progress-text"></div>
        <div id="timer">00:00</div>
      </div>

      <div id="quiz-content">
        <div id="question" class="question"></div>
        <div id="options" class="options"></div>
        <div id="explanation" class="explanation"></div>
      </div>
      <button id="next" class="nav-button" disabled>次の問題</button>
    </div>

    <div id="result-container"></div>
    <div id="attendance-link"></div>
  </div>

  <script>
    // —— クイズデータ（無効タグを除去し、Q1/10/12を軽微修正）——
    const quizData = [
      {
        "question":"炎症の5徴候のうち、「発赤」と「熱感（局所の温感）」の主な原因となるメカニズムはどれですか？",
        "options":["血管透過性の亢進","ブラジキニンによる疼痛刺激","白血球の組織への遊走","局所の血管拡張と血流増大"],
        "answer":3,
        "explanation":"発赤と熱感は、局所の血管拡張により温かい血液の流入が増えることで生じます。血管透過性亢進は主に腫脹の原因となります。"
      },
      {
        "question":"急性炎症の初期段階で、炎症部位に最初に集結し、貪食能と殺菌作用を持つ主要な白血球はどれですか？",
        "options":["好中球","リンパ球","単球（マクロファージ）","形質細胞"],
        "answer":0,
        "explanation":"好中球は急性炎症の初期に最初に動員され、貪食・殺菌で中心的に働きます。リンパ球やマクロファージは慢性炎症で主体となることが多いです。"
      },
      {
        "question":"白血球が炎症部位に移動する際、血管内皮細胞の表面を転がる「ローリング」に主に関与する接着分子はどれですか？",
        "options":["インテグリン","ケモカイン","セレクチン","ヒスタミン"],
        "answer":2,
        "explanation":"ローリングは内皮上のセレクチンと白血球糖鎖の弱い結合で起こります。続いてケモカインにより白血球インテグリンが活性化し、強固な接着に移行します。"
      },
      {
        "question":"肥満細胞（マスト細胞）から放出され、血管透過性の亢進や血管拡張を引き起こす、I型アレルギーや急性炎症の主要な化学伝達物質はどれですか？",
        "options":["ブラジキニン","ヒスタミン","プロスタグランジン","フィブリノーゲン"],
        "answer":1,
        "explanation":"ヒスタミンは肥満細胞の顆粒に豊富で、血管拡張と透過性亢進を強力に誘導します。"
      },
      {
        "question":"急性炎症が終息せず、マクロファージやリンパ球の浸潤が主体となり、組織の構造変化と機能欠損に至る炎症の病態を何と呼びますか？",
        "options":["急性炎症","慢性炎症","肉芽形成","滲出"],
        "answer":1,
        "explanation":"慢性炎症ではマクロファージやリンパ球が主体となり、組織破壊と修復が併存します。"
      },
      {
        "question":"体内で炎症が起きた際、血液検査で測定されるマーカーのうち、炎症刺激から数時間〜1日程度で上昇し、急性炎症の良い指標とされるタンパク質はどれですか？",
        "options":["サイトカイン (IL-6など)","CRP (C反応性タンパク)","赤沈 (赤血球沈降速度)","免疫グロブリン"],
        "answer":1,
        "explanation":"CRPはIL-6刺激で肝臓から産生され、数時間〜1日で上昇する急性期タンパクで、臨床で広く用いられます。"
      },
      {
        "question":"花粉症、気管支喘息、アナフィラキシーショックに共通するアレルギーの分類はどれですか？",
        "options":["I型（即時型）","II型（細胞障害型）","III型（免疫複合体型）","IV型（遅延型）"],
        "answer":0,
        "explanation":"I型アレルギーはIgEと肥満細胞が関与し、即時に反応が出現します。"
      },
      {
        "question":"I型アレルギーの発生機序において、ヒスタミンを放出する「脱顆粒」を引き起こす直接のトリガーはどれですか？",
        "options":["肥満細胞表面のIgEにアレルゲンが結合する","T細胞がアレルゲンを認識する","アレルゲンにIgG抗体が結合する","補体が活性化する"],
        "answer":0,
        "explanation":"アレルゲンが肥満細胞表面のIgEを架橋すると脱顆粒が起こり、ヒスタミンなどが放出されます。"
      },
      {
        "question":"血液型不適合輸血によって引き起こされる赤血球の破壊（溶血）は、どのアレルギー型に分類されますか？",
        "options":["I型（即時型）","II型（細胞障害型）","III型（免疫複合体型）","IV型（遅延型）"],
        "answer":1,
        "explanation":"II型は細胞表面抗原に対するIgG/IgMが介在し、補体活性化などで標的細胞が破壊されます。"
      },
      {
        "question":"抗原と抗体（主にIgG）が結合して形成された免疫複合体が、腎糸球体や血管壁に沈着して炎症を引き起こすアレルギー型はどれですか？",
        "options":["I型（即時型）","II型（細胞障害型）","III型（免疫複合体型）","IV型（遅延型）"],
        "answer":2,
        "explanation":"III型は免疫複合体の沈着を契機に補体・好中球が活性化して組織障害が生じます。RAはⅢ型要素に加え細胞性免疫も関与する多因子疾患である点に留意します。"
      },
      {
        "question":"金属アレルギーによる接触性皮膚炎やツベルクリン反応のように、T細胞が関与し、反応発現までに48時間程度を要するアレルギー型はどれですか？",
        "options":["I型（即時型）","II型（細胞障害型）","III型（免疫複合体型）","IV型（遅延型）"],
        "answer":3,
        "explanation":"IV型は感作T細胞がサイトカインを放出して惹起される遅延型過敏反応です。"
      },
      {
        "question":"バセドウ病の原因となる、TSH受容体に結合して甲状腺を持続刺激する自己抗体による病態はどの分類ですか？",
        "options":["II型（細胞障害型）","III型（免疫複合体型）","IV型（遅延型）","V型（刺激型）"],
        "answer":3,
        "explanation":"多くの資料で“V型（刺激型）”として説明されますが、教科書によっては“II型（抗体介在・非細胞障害型）”に含める流儀もあります。授業で流儀を明示してください。"
      },
      {
        "question":"免疫システムが自己の生体成分を非自己と誤認し、自身を攻撃してしまう疾患群の総称は何ですか？",
        "options":["アレルギー","免疫不全症","自己免疫疾患","日和見感染"],
        "answer":2,
        "explanation":"自己抗原に対する異常な免疫応答により、自己組織が傷害される疾患群を自己免疫疾患と呼びます。"
      },
      {
        "question":"関節リウマチ(RA)や全身性エリテマトーデス(SLE)のように、全身の血管・結合組織・関節が傷害される自己免疫疾患群を何と呼びますか？",
        "options":["膠原病","臓器特異的自己免疫疾患","免疫不全症","アレルギー性疾患"],
        "answer":0,
        "explanation":"膠原病は結合組織や血管を主座とする全身性自己免疫疾患群の総称です。"
      },
      {
        "question":"涙腺や唾液腺が自己免疫により破壊され、乾燥症状を呈する膠原病はどれですか？",
        "options":["全身性エリテマトーデス (SLE)","進行性全身性硬化症 (PSS)","関節リウマチ (RA)","シェーグレン症候群"],
        "answer":3,
        "explanation":"シェーグレン症候群では涙腺・唾液腺の自己免疫性炎症によりドライアイ・ドライマウスが生じます。"
      },
      {
        "question":"臓器移植において、移植を受けた患者の免疫系が移植臓器を非自己として攻撃する反応は何ですか？",
        "options":["移植片対宿主病 (GVHD)","拒絶反応","アナフィラキシーショック","自己免疫"],
        "answer":1,
        "explanation":"拒絶反応はレシピエントの免疫系がドナー臓器を攻撃する現象です。"
      },
      {
        "question":"骨髄移植などで、移植片に含まれるドナーのリンパ球が宿主の組織を攻撃する重篤な合併症は何ですか？",
        "options":["移植片対宿主病 (GVHD)","拒絶反応","II型アレルギー","日和見感染"],
        "answer":0,
        "explanation":"GVHDはドナーリンパ球が宿主組織を非自己と認識して攻撃する現象です。"
      },
      {
        "question":"移植時の拒絶反応を抑えるために適合性が重要となる、個体差の大きい細胞表面の“自分のしるし”タンパク質複合体は何ですか？",
        "options":["免疫グロブリン","MHC (主要組織適合遺伝子複合体)","サイトカイン","ケモカイン"],
        "answer":1,
        "explanation":"MHC（ヒトではHLA）は自己認識に関与し、移植適合性の判定に不可欠です。"
      },
      {
        "question":"後天性免疫不全症候群（AIDS）の原因であるHIVが主に感染・破壊する細胞はどれですか？",
        "options":["ヘルパーT細胞","B細胞","好中球","NK細胞"],
        "answer":0,
        "explanation":"HIVはCD4陽性ヘルパーT細胞に感染し、免疫の司令塔機能を障害します。"
      },
      {
        "question":"新生児が生後数ヶ月間、母体から胎盤経由で受け取った抗体により守られる受動免疫に関与する抗体はどれですか？",
        "options":["IgA","IgE","IgG","IgM"],
        "answer":2,
        "explanation":"胎盤を通過できる主要な免疫グロブリンはIgGです。"
      }
    ];

    // —— ユーティリティ —— 
    const $ = (id) => document.getElementById(id);
    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [array[i],array[j]] = [array[j],array[i]];
      }
      return array;
    }

    // —— 状態 —— 
    let current = 0, score = 0, userAnswers = [];
    let order = [];        // 全設問の並び
    let optionOrder = [];  // 各設問ごとの選択肢インデックス並び
    let timer = null, seconds = 0;

    function startTimer(){
      if(timer) clearInterval(timer);
      seconds = 0; $('timer').textContent = '00:00';
      timer = setInterval(()=>{
        seconds++;
        const m = String(Math.floor(seconds/60)).padStart(2,'0');
        const s = String(seconds%60).padStart(2,'0');
        $('timer').textContent = `${m}:${s}`;
      },1000);
    }

    function initQuiz(){
      // 設問の順番をシャッフル
      order = shuffle([...Array(quizData.length).keys()]);
      // 各設問の選択肢インデックスをシャッフル
      optionOrder = order.map(qi => shuffle([0,1,2,3]));
      userAnswers = Array(quizData.length).fill(null);
      current = 0; score = 0;
      startTimer();
      renderQuestion();
    }

    function renderQuestion(){
      const qIndex = order[current];
      const q = quizData[qIndex];

      // 進捗
      const prog = ((current+1)/quizData.length)*100;
      $('progress-bar').style.width = `${prog}%`;
      $('progress-text').textContent = `${current+1} / ${quizData.length} 問`;

      // 本文
      $('question').textContent = q.question;

      // 選択肢（indexで安全にハンドリング）
      const idxOrder = optionOrder[current];
      $('options').innerHTML = idxOrder.map((optIdx,i)=>(
        `<button class="option" data-opt="${optIdx}" onclick="selectOption(${optIdx}, this)">${q.options[optIdx]}</button>`
      )).join('');

      // 解説リセット
      const exp = $('explanation');
      exp.style.display='none'; exp.style.opacity='0'; exp.innerHTML='';
      $('next').disabled = true;
    }

    window.selectOption = function(originalOptionIndex, el){
      // 全て無効化
      document.querySelectorAll('.option').forEach(o=>o.classList.add('disabled'));
      el.classList.add('selected');

      const qIndex = order[current];
      const q = quizData[qIndex];
      const isCorrect = (originalOptionIndex === q.answer);
      userAnswers[qIndex] = originalOptionIndex;
      if(isCorrect){ el.classList.add('correct'); score++; }
      else{
        el.classList.add('incorrect');
        // 正解に色
        document.querySelectorAll('.option').forEach(o=>{
          const idx = Number(o.getAttribute('data-opt'));
          if(idx === q.answer){ o.classList.add('correct'); }
        });
      }

      const exp = $('explanation');
      exp.innerHTML = `
        <div class="explanation-header" style="color:${isCorrect ? '#4caf50' : '#f44336'};">
          <span class="explanation-icon">💡</span>解説
        </div>
        ${q.explanation}
      `;
      exp.style.borderLeftColor = isCorrect ? '#4caf50' : '#f44336';
      exp.style.display='block';
      requestAnimationFrame(()=> exp.style.opacity='1');

      $('next').disabled = false;
    };

    $('next').addEventListener('click', ()=>{
      if(current < quizData.length-1){ current++; renderQuestion(); }
      else{ showResult(); }
    });

    function showResult(){
      clearInterval(timer);
      const finalTime = $('timer').textContent;
      $('quiz-container').style.display = 'none';

      const total = quizData.length;
      const pct = (score/total)*100;
      let color = '#34c759', msg = '素晴らしい成績です！この調子で学習を続けましょう。';
      if(pct < 40){ color = '#ff3b30'; msg = 'お疲れ様でした！間違えた問題を中心にしっかり復習しましょう。'; }
      else if(pct < 80){ color = '#ff9500'; msg = 'あと一歩！間違えた箇所を復習すれば、さらに実力がアップします。'; }
      if(pct === 100){ msg = '完璧です！素晴らしい集中力と知識です。おめでとうございます！'; }

      // 成績サマリー
      const summary = `
        <div class="result-card" id="summary-card">
          <div class="summary-grid">
            <div class="score-display">
              <div class="score-circle" style="--p:${pct.toFixed(1)}; --c:${color};">
                <span class="score-percentage">${Math.round(pct)}<small>%</small></span>
              </div>
            </div>
            <div class="stats-details">
              <div class="stat-item"><span class="stat-icon">✅</span><span class="stat-label">正解数</span><span class="stat-value">${score} / ${total}</span></div>
              <div class="stat-item"><span class="stat-icon">⏱️</span><span class="stat-label">所要時間</span><span class="stat-value">${finalTime}</span></div>
            </div>
          </div>
          <p class="feedback-message" style="color:${color};">${msg}</p>
        </div>
      `;

      // 間違い一覧
      const wrong = [];
      quizData.forEach((q, qi)=>{
        if(userAnswers[qi] === null) return;
        if(userAnswers[qi] !== q.answer) wrong.push(qi+1);
      });

      let html = `<h2>クイズ結果</h2>${summary}`;
      if(wrong.length){
        html += `
          <div id="incorrect-summary">
            <h3>要復習の問題</h3>
            ${wrong.map(n=>`<a href="#result-q-${n}">${n}</a>`).join('')}
          </div>
        `;
      }

      // 各問のレビュー
      quizData.forEach((q, qi)=>{
        const ua = userAnswers[qi];
        const ok = (ua === q.answer);
        html += `
          <div class="result-card" id="result-q-${qi+1}">
            <h3>問題 ${qi+1}</h3>
            <p class="result-status ${ok ? 'correct':'incorrect'}">${ok ? '正解':'不正解'}</p>
            <p><strong>質問:</strong> ${q.question}</p>
            <p><strong>あなたの回答:</strong> ${ua !== null ? q.options[ua] : '未回答'}</p>
            <p><strong>正解:</strong> ${q.options[q.answer]}</p>
            <p><strong>説明:</strong> ${q.explanation}</p>
          </div>
        `;
      });

      html += `<button class="nav-button" onclick="restartQuiz()">もう一度挑戦する</button>`;
      $('result-container').innerHTML = html;

      if(pct === 100){
        const a = $('attendance-link');
        a.style.display = 'block';
        a.innerHTML = `<p>おめでとうございます！全問正解です。</p>
          <a href="https://forms.gle/jCUgdfcFLPitJqCaA" target="_blank" rel="noopener">出席確認フォームに回答する</a>`;
      }
    }

    window.restartQuiz = function(){
      $('quiz-container').style.display = 'block';
      $('result-container').innerHTML = '';
      $('attendance-link').style.display = 'none';
      initQuiz();
    };

    // 起動
    initQuiz();
  </script>
</body>
</html>
